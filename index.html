<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Pinjaman Buku - Pusat Sumber SK Inanam II</title>
    <script src="https://cdn.tailwindcss.com">
async function loadDataFromSheet() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getData');
        const data = await response.json();

        if (data.muridList) muridList = data.muridList;
        if (data.pinjamanList) pinjamanList = data.pinjamanList;

        // Cache locally for faster reloads
        localStorage.setItem('muridList', JSON.stringify(muridList));
        localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));

        // Refresh UI
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();

    } catch (error) {
        console.error('Error loading from Google Sheets:', error);
        // Fallback to local cache if offline
        muridList = JSON.parse(localStorage.getItem('muridList')) || [];
        pinjamanList = JSON.parse(localStorage.getItem('pinjamanList')) || [];
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();
    }
}

</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">
async function loadDataFromSheet() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getData');
        const data = await response.json();

        if (data.muridList) muridList = data.muridList;
        if (data.pinjamanList) pinjamanList = data.pinjamanList;

        // Cache locally for faster reloads
        localStorage.setItem('muridList', JSON.stringify(muridList));
        localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));

        // Refresh UI
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();

    } catch (error) {
        console.error('Error loading from Google Sheets:', error);
        // Fallback to local cache if offline
        muridList = JSON.parse(localStorage.getItem('muridList')) || [];
        pinjamanList = JSON.parse(localStorage.getItem('pinjamanList')) || [];
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();
    }
}

</script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold text-center">üìö SISTEM PENGURUSAN PINJAMAN BUKU</h1>
            <p class="text-center text-blue-100 mt-2 text-lg">Pusat Sumber SK Inanam II</p>
            <div class="text-center mt-2">
                <span class="inline-block bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">
                    üåê Versi Web Hosting | Akses dari Mana-mana Komputer
                </span>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-2 py-3">
                <button class="tab-button active px-4 py-2 rounded-lg font-medium transition-colors" onclick="showTab('dashboard')">
                    üìä Dashboard
                </button>
                <button class="tab-button px-4 py-2 rounded-lg font-medium transition-colors" onclick="showTab('murid')">
                    üë• Rekod Murid
                </button>
                <button class="tab-button px-4 py-2 rounded-lg font-medium transition-colors" onclick="showTab('pinjaman')">
                    üìñ Pinjaman Buku
                </button>
                <button class="tab-button px-4 py-2 rounded-lg font-medium transition-colors" onclick="showTab('senarai')">
                    üìã Senarai Pinjaman
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Tab: Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Dashboard Statistik Perpustakaan</h2>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Jumlah Murid</p>
                                <p class="text-3xl font-bold" id="totalMurid">0</p>
                            </div>
                            <div class="text-4xl">üë•</div>
                        </div>
                    </div>
                    
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Jumlah Pinjaman</p>
                                <p class="text-3xl font-bold" id="totalPinjaman">0</p>
                            </div>
                            <div class="text-4xl">üìö</div>
                        </div>
                    </div>
                    
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Sedang Dipinjam</p>
                                <p class="text-3xl font-bold" id="sedangDipinjam">0</p>
                            </div>
                            <div class="text-4xl">üìñ</div>
                        </div>
                    </div>
                    
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Telah Dikembalikan</p>
                                <p class="text-3xl font-bold" id="telahDikembalikan">0</p>
                            </div>
                            <div class="text-4xl">‚úÖ</div>
                        </div>
                    </div>
                    
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Lewat Pulang</p>
                                <p class="text-3xl font-bold" id="lewatPulang">0</p>
                            </div>
                            <div class="text-4xl">‚ö†Ô∏è</div>
                        </div>
                    </div>
                    
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Buku Hilang</p>
                                <p class="text-3xl font-bold" id="bukuHilang">0</p>
                            </div>
                            <div class="text-4xl">‚ùå</div>
                        </div>
                    </div>
                    
                    <div class="stat-card text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Peminjam Terbanyak</p>
                                <p class="text-lg font-bold" id="peminjamTerbanyak">-</p>
                                <p class="text-sm text-blue-200" id="jumlahPinjaman">0 pinjaman</p>
                            </div>
                            <div class="text-4xl">üèÜ</div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Status Pinjaman</h3>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Pinjaman Mengikut Kelas</h3>
                        <div class="chart-container">
                            <canvas id="kelasChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Borrowers Section -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">üèÜ Senarai Peminjam Terbanyak Bulan Ini</h3>
                        <select id="pilihBulan" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Bulan Semasa</option>
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Mac</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Jun</option>
                            <option value="6">Julai</option>
                            <option value="7">Ogos</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Disember</option>
                        </select>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kedudukan</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Murid</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Jumlah Pinjaman</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Status Terkini</th>
                                </tr>
                            </thead>
                            <tbody id="senaraiPeminjamTerbanyak">
                                <!-- Data peminjam terbanyak akan dipaparkan di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Rekod Murid -->
        <div id="murid" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üë• Pengurusan Rekod Murid</h2>
                
                <!-- Form Tambah Murid Manual -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Murid Secara Manual</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="namaMurid" placeholder="Nama Murid" 
                               class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="kelasMurid" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                            <option value="3 BERLIAN">3 BERLIAN</option>
                            <option value="3 DELIMA">3 DELIMA</option>
                            <option value="3 INTAN">3 INTAN</option>
                            <option value="3 MUTIARA">3 MUTIARA</option>
                            <option value="3 ZAMRUD">3 ZAMRUD</option>
                            <option value="4 BERLIAN">4 BERLIAN</option>
                            <option value="4 DELIMA">4 DELIMA</option>
                            <option value="4 INTAN">4 INTAN</option>
                            <option value="4 MUTIARA">4 MUTIARA</option>
                            <option value="4 ZAMRUD">4 ZAMRUD</option>
                            <option value="5 BERLIAN">5 BERLIAN</option>
                            <option value="5 DELIMA">5 DELIMA</option>
                            <option value="5 INTAN">5 INTAN</option>
                            <option value="5 MUTIARA">5 MUTIARA</option>
                            <option value="5 ZAMRUD">5 ZAMRUD</option>
                            <option value="6 BERLIAN">6 BERLIAN</option>
                            <option value="6 DELIMA">6 DELIMA</option>
                            <option value="6 INTAN">6 INTAN</option>
                            <option value="6 MUTIARA">6 MUTIARA</option>
                            <option value="6 ZAMRUD">6 ZAMRUD</option>
                        </select>
                        <button onclick="tambahMurid()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            ‚ûï Tambah Murid
                        </button>
                    </div>
                </div>

                <!-- Upload CSV -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Muat Naik Fail CSV</h3>
                    <div class="flex items-center space-x-4">
                        <input type="file" id="csvFile" accept=".csv" 
                               class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="muatNaikCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            üìÅ Muat Naik CSV
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Format CSV: nama,kelas (contoh: Ahmad Bin Ali,5A)</p>
                </div>

                <!-- Senarai Murid -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gray-700">Senarai Murid Berdaftar</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="cariMurid" placeholder="üîç Cari nama murid..." 
                                   class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="cariMurid()">
                            <select id="tapisKelas" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onchange="tapisMuridMengikutKelas()">
                                <option value="">Semua Kelas</option>
                                <option value="3 BERLIAN">3 BERLIAN</option>
                                <option value="3 DELIMA">3 DELIMA</option>
                                <option value="3 INTAN">3 INTAN</option>
                                <option value="3 MUTIARA">3 MUTIARA</option>
                                <option value="3 ZAMRUD">3 ZAMRUD</option>
                                <option value="4 BERLIAN">4 BERLIAN</option>
                                <option value="4 DELIMA">4 DELIMA</option>
                                <option value="4 INTAN">4 INTAN</option>
                                <option value="4 MUTIARA">4 MUTIARA</option>
                                <option value="4 ZAMRUD">4 ZAMRUD</option>
                                <option value="5 BERLIAN">5 BERLIAN</option>
                                <option value="5 DELIMA">5 DELIMA</option>
                                <option value="5 INTAN">5 INTAN</option>
                                <option value="5 MUTIARA">5 MUTIARA</option>
                                <option value="5 ZAMRUD">5 ZAMRUD</option>
                                <option value="6 BERLIAN">6 BERLIAN</option>
                                <option value="6 DELIMA">6 DELIMA</option>
                                <option value="6 INTAN">6 INTAN</option>
                                <option value="6 MUTIARA">6 MUTIARA</option>
                                <option value="6 ZAMRUD">6 ZAMRUD</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left">Bil</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama Murid</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="senaraiMurid">
                                <!-- Data murid akan dipaparkan di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Pinjaman Buku -->
        <div id="pinjaman" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìñ Rekod Pinjaman Buku</h2>
                
                <form id="formPinjaman" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="pilihKelas" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                            <option value="3 BERLIAN">3 BERLIAN</option>
                            <option value="3 DELIMA">3 DELIMA</option>
                            <option value="3 INTAN">3 INTAN</option>
                            <option value="3 MUTIARA">3 MUTIARA</option>
                            <option value="3 ZAMRUD">3 ZAMRUD</option>
                            <option value="4 BERLIAN">4 BERLIAN</option>
                            <option value="4 DELIMA">4 DELIMA</option>
                            <option value="4 INTAN">4 INTAN</option>
                            <option value="4 MUTIARA">4 MUTIARA</option>
                            <option value="4 ZAMRUD">4 ZAMRUD</option>
                            <option value="5 BERLIAN">5 BERLIAN</option>
                            <option value="5 DELIMA">5 DELIMA</option>
                            <option value="5 INTAN">5 INTAN</option>
                            <option value="5 MUTIARA">5 MUTIARA</option>
                            <option value="5 ZAMRUD">5 ZAMRUD</option>
                            <option value="6 BERLIAN">6 BERLIAN</option>
                            <option value="6 DELIMA">6 DELIMA</option>
                            <option value="6 INTAN">6 INTAN</option>
                            <option value="6 MUTIARA">6 MUTIARA</option>
                            <option value="6 ZAMRUD">6 ZAMRUD</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Murid</label>
                        <select id="pilihMurid" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Murid</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tajuk Buku</label>
                        <input type="text" id="tajukBuku" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tarikh Pinjaman</label>
                        <input type="date" id="tarikhPinjaman" required 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tarikh Pulang (Automatik)</label>
                        <input type="date" id="tarikhPulangan" readonly 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tarikh Sebenar Pulang (Opsional)</label>
                        <input type="date" id="tarikhSebenarPulang" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <textarea id="catatan" rows="3" placeholder="Catatan tambahan (opsional)"
                                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            üìù Rekod Pinjaman
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Senarai Pinjaman -->
        <div id="senarai" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üìã Senarai Pinjaman & Pengurusan</h2>
                    <button onclick="cetakLaporan()" class="no-print bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        üñ®Ô∏è Cetak Laporan
                    </button>
                </div>
                
                <div class="print-area">
                    <div class="text-center mb-6 print-only">
                        <h1 class="text-2xl font-bold">LAPORAN PINJAMAN BUKU</h1>
                        <h2 class="text-lg">Pusat Sumber SK Inanam II</h2>
                        <p class="text-sm mt-2">Tarikh Cetak: <span id="tarikhCetak"></span></p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-2 py-2">Bil</th>
                                    <th class="border border-gray-300 px-2 py-2">Nama</th>
                                    <th class="border border-gray-300 px-2 py-2">Kelas</th>
                                    <th class="border border-gray-300 px-2 py-2">Tajuk Buku</th>
                                    <th class="border border-gray-300 px-2 py-2">Tarikh Pinjam</th>
                                    <th class="border border-gray-300 px-2 py-2">Tarikh Pulang</th>
                                    <th class="border border-gray-300 px-2 py-2">Sebenar Pulang</th>
                                    <th class="border border-gray-300 px-2 py-2">Status</th>
                                    <th class="border border-gray-300 px-2 py-2">Catatan</th>
                                    <th class="border border-gray-300 px-2 py-2">Denda</th>
                                    <th class="border border-gray-300 px-2 py-2 no-print">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="senaraiPinjaman">
                                <!-- Data pinjaman akan dipaparkan di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="modalKonfirmasi" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-bold mb-4">Pengesahan</h3>
            <p id="pesanKonfirmasi" class="mb-4"></p>
            <div class="flex space-x-4">
                <button id="btnYa" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Ya</button>
                <button id="btnTidak" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Tidak</button>
            </div>
        </div>
    </div>

    <script>
        // URL Google Apps Script - Gantikan dengan URL anda
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsEk1rOTWucr7gDTgawLBA4eUXy_qsvg1yBQM6hK20VnpUsgNdD1J5CpsxRzrNSGcM/exec';
        
        // Configuration for hosting
        const CONFIG = {
            APP_NAME: 'Sistem Pengurusan Pinjaman Buku',
            SCHOOL_NAME: 'Pusat Sumber SK Inanam II',
            VERSION: '2.0',
            LAST_UPDATED: '2024'
        };
        
        // Data storage
        let muridList = [];
let pinjamanList = [];

// Load from Google Sheets when page loads
document.addEventListener('DOMContentLoaded', loadDataFromSheet);

        
        // Charts
        let statusChart, kelasChart;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            muatSenaraiMurid();
            muatJadualPinjaman();
            setTarikhHariIni();
            updateDashboard();
            initCharts();
            
            // Event listeners
            document.getElementById('pilihKelas').addEventListener('change', function() {
                muatMuridMengikutKelas(this.value);
            });
            
            document.getElementById('tarikhPinjaman').addEventListener('change', function() {
                const tarikhPinjaman = new Date(this.value);
                const tarikhPulangan = new Date(tarikhPinjaman);
                tarikhPulangan.setDate(tarikhPulangan.getDate() + 7);
                document.getElementById('tarikhPulangan').value = tarikhPulangan.toISOString().split('T')[0];
            });
            
            document.getElementById('formPinjaman').addEventListener('submit', function(e) {
                e.preventDefault();
                rekodPinjaman();
            });
            
            document.getElementById('pilihBulan').addEventListener('change', function() {
                updateTopBorrowers();
            });
        });

        // Tab functions
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Update dashboard when switching to dashboard tab
            if (tabName === 'dashboard') {
                updateDashboard();
                updateCharts();
            }
        }

        // Set today's date
        function setTarikhHariIni() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tarikhPinjaman').value = today;
            
            const tarikhPulangan = new Date();
            tarikhPulangan.setDate(tarikhPulangan.getDate() + 7);
            document.getElementById('tarikhPulangan').value = tarikhPulangan.toISOString().split('T')[0];
        }

        // Murid management functions
        function tambahMurid() {
            const nama = document.getElementById('namaMurid').value.trim();
            const kelas = document.getElementById('kelasMurid').value;
            
            // Enhanced validation
            if (!nama || nama.length < 2) {
                alert('‚ùå Sila masukkan nama murid yang sah (sekurang-kurangnya 2 huruf).');
                document.getElementById('namaMurid').focus();
                return;
            }
            
            if (!kelas) {
                alert('‚ùå Sila pilih kelas murid.');
                document.getElementById('kelasMurid').focus();
                return;
            }
            
            // Check for valid name format (letters, spaces, and common Malaysian name characters)
            const namePattern = /^[a-zA-Z\s.'@/-]+$/;
            if (!namePattern.test(nama)) {
                alert('‚ùå Nama murid mengandungi aksara yang tidak sah. Gunakan huruf sahaja.');
                document.getElementById('namaMurid').focus();
                return;
            }
            
            // Proper case formatting for name
            const formattedNama = nama.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            
            // Check if student already exists (case insensitive)
            const existingStudent = muridList.find(m => 
                m.nama.toLowerCase() === formattedNama.toLowerCase() && m.kelas === kelas
            );
            
            if (existingStudent) {
                alert(`‚ùå Murid "${formattedNama}" dari kelas ${kelas} sudah wujud dalam senarai.\n\nSila semak senarai murid berdaftar.`);
                document.getElementById('namaMurid').focus();
                return;
            }
            
            // Add student with formatted name
            muridList.push({ 
                nama: formattedNama, 
                kelas: kelas,
                tarikhDaftar: new Date().toISOString().split('T')[0]
            });
            localStorage.setItem('muridList', JSON.stringify(muridList));
            
            
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'saveData',
                type: 'muridList',
                data: muridList
            })
        });
        if (response.ok) {
            loadDataFromSheet(); // Reload data from Sheets
        } else {
            throw new Error('Failed to save to Google Sheets');
        }
    } catch (error) {
        console.error('Save error:', error);
    }
// Clear form
            document.getElementById('namaMurid').value = '';
            document.getElementById('kelasMurid').value = '';
            
            muatSenaraiMurid();
            updateDashboard();
            
            alert(`‚úÖ Murid "${formattedNama}" dari kelas ${kelas} berjaya ditambah!\n\nJumlah murid berdaftar: ${muridList.length}`);
        }

        function muatNaikCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ùå Sila pilih fail CSV.');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('‚ùå Sila pilih fail CSV yang sah (.csv).');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                let count = 0;
                let duplicates = 0;
                let errors = [];
                
                lines.forEach((line, index) => {
                    const [nama, kelas] = line.split(',').map(item => item.trim());
                    
                    if (!nama || !kelas) {
                        errors.push(`Baris ${index + 1}: Data tidak lengkap - "${line}"`);
                        return;
                    }
                    
                    // Validate name format
                    const namePattern = /^[a-zA-Z\s.'@/-]+$/;
                    if (!namePattern.test(nama)) {
                        errors.push(`Baris ${index + 1}: Nama tidak sah - "${nama}"`);
                        return;
                    }
                    
                    // Format name properly
                    const formattedNama = nama.split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                    
                    // Check if student already exists
                    if (muridList.some(m => m.nama.toLowerCase() === formattedNama.toLowerCase() && m.kelas === kelas)) {
                        duplicates++;
                        return;
                    }
                    
                    // Validate class
                    const validClasses = ['3 BERLIAN', '3 DELIMA', '3 INTAN', '3 MUTIARA', '3 ZAMRUD', 
                                        '4 BERLIAN', '4 DELIMA', '4 INTAN', '4 MUTIARA', '4 ZAMRUD',
                                        '5 BERLIAN', '5 DELIMA', '5 INTAN', '5 MUTIARA', '5 ZAMRUD',
                                        '6 BERLIAN', '6 DELIMA', '6 INTAN', '6 MUTIARA', '6 ZAMRUD'];
                    
                    if (!validClasses.includes(kelas.toUpperCase())) {
                        errors.push(`Baris ${index + 1}: Kelas tidak sah - "${kelas}"`);
                        return;
                    }
                    
                    muridList.push({ 
                        nama: formattedNama, 
                        kelas: kelas.toUpperCase(),
                        tarikhDaftar: new Date().toISOString().split('T')[0]
                    });
                    count++;
                });
                
                localStorage.setItem('muridList', JSON.stringify(muridList));
                muatSenaraiMurid();
                updateDashboard();
                
                // Show detailed results
                let message = `üìä HASIL MUAT NAIK CSV:\n\n`;
                message += `‚úÖ Berjaya ditambah: ${count} murid\n`;
                if (duplicates > 0) message += `‚ö†Ô∏è Diabaikan (sudah wujud): ${duplicates} murid\n`;
                if (errors.length > 0) {
                    message += `‚ùå Ralat: ${errors.length} baris\n\n`;
                    message += `SENARAI RALAT:\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) message += `\n... dan ${errors.length - 5} ralat lagi`;
                }
                message += `\n\nüìã Jumlah murid berdaftar: ${muridList.length}`;
                
                alert(message);
                fileInput.value = '';
            };
            
            reader.readAsText(file);
        }

        function muatSenaraiMurid() {
            const tbody = document.getElementById('senaraiMurid');
            tbody.innerHTML = '';
            
            // Sort students by class then by name for better organization
            const sortedMurid = [...muridList].sort((a, b) => {
                if (a.kelas !== b.kelas) {
                    return a.kelas.localeCompare(b.kelas);
                }
                return a.nama.localeCompare(b.nama);
            });
            
            sortedMurid.forEach((murid, index) => {
                const row = tbody.insertRow();
                const originalIndex = muridList.findIndex(m => m.nama === murid.nama && m.kelas === murid.kelas);
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2 text-center font-medium">${index + 1}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <div class="font-semibold text-gray-800">${murid.nama}</div>
                        <div class="text-xs text-gray-500">ID: ${originalIndex + 1}</div>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">
                            ${murid.kelas}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        <button onclick="padamMurid(${originalIndex})" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                            üóëÔ∏è Padam
                        </button>
                    </td>
                `;
            });
            
            // Add summary row
            if (muridList.length > 0) {
                const summaryRow = tbody.insertRow();
                summaryRow.innerHTML = `
                    <td colspan="4" class="border border-gray-300 px-4 py-2 bg-gray-50 text-center font-medium text-gray-600">
                        üìä Jumlah Keseluruhan: ${muridList.length} murid berdaftar
                    </td>
                `;
            }
        }

        function muatMuridMengikutKelas(kelas) {
            const select = document.getElementById('pilihMurid');
            select.innerHTML = '<option value="">Pilih Murid</option>';
            
            if (!kelas) return;
            
            const muridDalamKelas = muridList.filter(murid => murid.kelas === kelas);
            muridDalamKelas.forEach(murid => {
                const option = document.createElement('option');
                option.value = murid.nama;
                option.textContent = murid.nama;
                select.appendChild(option);
            });
        }

        function padamMurid(index) {
            const murid = muridList[index];
            if (confirm(`Adakah anda pasti ingin memadam murid ini?\n\nNama: ${murid.nama}\nKelas: ${murid.kelas}\n\nTindakan ini tidak boleh dibatalkan.`)) {
                muridList.splice(index, 1);
                localStorage.setItem('muridList', JSON.stringify(muridList));
                muatSenaraiMurid();
                updateDashboard();
                alert(`‚úÖ Murid "${murid.nama}" telah dipadam dari senarai.`);
            }
        }

        // Search and filter functions
        function cariMurid() {
            const searchTerm = document.getElementById('cariMurid').value.toLowerCase();
            const filterClass = document.getElementById('tapisKelas').value;
            
            let filteredMurid = muridList;
            
            // Filter by search term
            if (searchTerm) {
                filteredMurid = filteredMurid.filter(murid => 
                    murid.nama.toLowerCase().includes(searchTerm)
                );
            }
            
            // Filter by class
            if (filterClass) {
                filteredMurid = filteredMurid.filter(murid => murid.kelas === filterClass);
            }
            
            displayFilteredMurid(filteredMurid);
        }

        function tapisMuridMengikutKelas() {
            cariMurid(); // Use the same filtering logic
        }

        function displayFilteredMurid(filteredMurid) {
            const tbody = document.getElementById('senaraiMurid');
            tbody.innerHTML = '';
            
            if (filteredMurid.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="4" class="border border-gray-300 px-4 py-2 text-center text-gray-500">
                        ‚ùå Tiada murid dijumpai berdasarkan carian/tapisan
                    </td>
                `;
                return;
            }
            
            // Sort filtered results
            const sortedMurid = [...filteredMurid].sort((a, b) => {
                if (a.kelas !== b.kelas) {
                    return a.kelas.localeCompare(b.kelas);
                }
                return a.nama.localeCompare(b.nama);
            });
            
            sortedMurid.forEach((murid, index) => {
                const row = tbody.insertRow();
                const originalIndex = muridList.findIndex(m => m.nama === murid.nama && m.kelas === murid.kelas);
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2 text-center font-medium">${index + 1}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <div class="font-semibold text-gray-800">${murid.nama}</div>
                        <div class="text-xs text-gray-500">ID: ${originalIndex + 1}</div>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">
                            ${murid.kelas}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        <button onclick="padamMurid(${originalIndex})" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                            üóëÔ∏è Padam
                        </button>
                    </td>
                `;
            });
            
            // Add summary row
            const summaryRow = tbody.insertRow();
            summaryRow.innerHTML = `
                <td colspan="4" class="border border-gray-300 px-4 py-2 bg-gray-50 text-center font-medium text-gray-600">
                    üìä Menunjukkan ${filteredMurid.length} daripada ${muridList.length} murid berdaftar
                </td>
            `;
        }

        // Loan management functions
        async function rekodPinjaman() {
            const kelas = document.getElementById('pilihKelas').value;
            const namaMurid = document.getElementById('pilihMurid').value;
            const tajukBuku = document.getElementById('tajukBuku').value;
            const tarikhPinjaman = document.getElementById('tarikhPinjaman').value;
            const tarikhPulangan = document.getElementById('tarikhPulangan').value;
            const tarikhSebenarPulang = document.getElementById('tarikhSebenarPulang').value;
            const catatan = document.getElementById('catatan').value;
            
            if (!kelas || !namaMurid || !tajukBuku || !tarikhPinjaman) {
                alert('Sila isi semua medan yang diperlukan.');
                return;
            }
            
            const timestamp = new Date().getTime();
            let status = 'Dipinjam';
            let catatanFinal = catatan;
            let denda = 0;
            
            if (tarikhSebenarPulang) {
                if (new Date(tarikhSebenarPulang) > new Date(tarikhPulangan)) {
                    const hariLewat = Math.ceil((new Date(tarikhSebenarPulang) - new Date(tarikhPulangan)) / (1000 * 60 * 60 * 24));
                    denda = hariLewat * 0.10;
                    status = 'Lewat';
                    catatanFinal = `Lewat ${hariLewat} hari ‚Äì RM${denda.toFixed(2)}${catatan ? '. ' + catatan : ''}`;
                } else {
                    status = 'Dikembalikan';
                    catatanFinal = `Dikembalikan tepat pada masa${catatan ? '. ' + catatan : ''}`;
                }
            }
            
            const pinjamanData = {
                timestamp: new Date().toISOString(),
                nama: namaMurid,
                kelas: kelas,
                tajukBuku: tajukBuku,
                tarikhPinjaman: tarikhPinjaman,
                tarikhPulangan: tarikhPulangan,
                tarikhSebenarPulang: tarikhSebenarPulang || '',
                status: status,
                catatan: catatanFinal,
                denda: denda,
                id: timestamp
            };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pinjamanData)
                });
                
                if (response.ok) {
                    pinjamanList.push(pinjamanData);
                    localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                    
                    
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'saveData',
                type: 'pinjamanList',
                data: pinjamanList
            })
        });
        if (response.ok) {
            loadDataFromSheet(); // Reload data from Sheets
        } else {
            throw new Error('Failed to save to Google Sheets');
        }
    } catch (error) {
        console.error('Save error:', error);
    }
// Clear form
                    document.getElementById('formPinjaman').reset();
                    setTarikhHariIni();
                    
                    muatJadualPinjaman();
                    updateDashboard();
                    alert('Pinjaman berjaya direkod!');
                } else {
                    throw new Error('Gagal menghantar data');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ralat: Tidak dapat menghantar data ke Google Sheets. Data disimpan secara tempatan.');
                
                // Save locally even if Google Sheets fails
                pinjamanList.push(pinjamanData);
                localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                
                // Clear form
                document.getElementById('formPinjaman').reset();
                setTarikhHariIni();
                
                muatJadualPinjaman();
                updateDashboard();
            }
        }

        function muatJadualPinjaman() {
            const tbody = document.getElementById('senaraiPinjaman');
            tbody.innerHTML = '';
            
            pinjamanList.forEach((pinjaman, index) => {
                const row = tbody.insertRow();
                const statusClass = pinjaman.status === 'Lewat' ? 'text-red-600 font-bold' : 
                                  pinjaman.status === 'Dikembalikan' ? 'text-green-600' : 
                                  pinjaman.status === 'Hilang' ? 'text-red-800 font-bold' : 'text-blue-600';
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-2 py-2">${index + 1}</td>
                    <td class="border border-gray-300 px-2 py-2">${pinjaman.nama}</td>
                    <td class="border border-gray-300 px-2 py-2">${pinjaman.kelas}</td>
                    <td class="border border-gray-300 px-2 py-2">${pinjaman.tajukBuku}</td>
                    <td class="border border-gray-300 px-2 py-2">${formatTarikh(pinjaman.tarikhPinjaman)}</td>
                    <td class="border border-gray-300 px-2 py-2">${formatTarikh(pinjaman.tarikhPulangan)}</td>
                    <td class="border border-gray-300 px-2 py-2">${pinjaman.tarikhSebenarPulang ? formatTarikh(pinjaman.tarikhSebenarPulang) : '-'}</td>
                    <td class="border border-gray-300 px-2 py-2 ${statusClass}">${pinjaman.status}</td>
                    <td class="border border-gray-300 px-2 py-2">${pinjaman.catatan}</td>
                    <td class="border border-gray-300 px-2 py-2">${pinjaman.denda > 0 ? 'RM' + pinjaman.denda.toFixed(2) : '-'}</td>
                    <td class="border border-gray-300 px-2 py-2 no-print">
                        <div class="flex flex-col space-y-1">
                            ${pinjaman.status === 'Dipinjam' ? 
                                `<button onclick="kembalikanBuku(${index})" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                                    ‚Ü©Ô∏è Kembalikan
                                </button>
                                <button onclick="tandakanHilang(${index})" class="bg-orange-600 text-white px-2 py-1 rounded text-xs hover:bg-orange-700">
                                    ‚ùå Hilang
                                </button>` : ''}
                            <button onclick="padamPinjaman(${index})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">
                                üóëÔ∏è Padam
                            </button>
                        </div>
                    </td>
                `;
            });
        }

        function formatTarikh(tarikh) {
            if (!tarikh) return '-';
            const date = new Date(tarikh);
            return date.toLocaleDateString('ms-MY');
        }

        async function kembalikanBuku(index) {
            const today = new Date().toISOString().split('T')[0];
            const pinjaman = pinjamanList[index];
            
            pinjaman.tarikhSebenarPulang = today;
            
            if (new Date(today) > new Date(pinjaman.tarikhPulangan)) {
                const hariLewat = Math.ceil((new Date(today) - new Date(pinjaman.tarikhPulangan)) / (1000 * 60 * 60 * 24));
                pinjaman.denda = hariLewat * 0.10;
                pinjaman.catatan = `Lewat ${hariLewat} hari ‚Äì RM${pinjaman.denda.toFixed(2)}`;
                pinjaman.status = 'Lewat';
            } else {
                pinjaman.status = 'Dikembalikan';
                pinjaman.catatan = 'Dikembalikan tepat pada masa';
            }
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...pinjaman,
                        action: 'update'
                    })
                });
                
                if (response.ok) {
                    localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                    muatJadualPinjaman();
                    updateDashboard();
                    alert('Buku berjaya dikembalikan!');
                } else {
                    throw new Error('Gagal mengemas kini data');
                }
            } catch (error) {
                console.error('Error:', error);
                localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                muatJadualPinjaman();
                updateDashboard();
                alert('Buku dikembalikan (disimpan secara tempatan)');
            }
        }

        async function tandakanHilang(index) {
            showModal('Adakah anda pasti ingin menandakan buku ini sebagai hilang?', async function() {
                const pinjaman = pinjamanList[index];
                pinjaman.status = 'Hilang';
                pinjaman.catatan = 'Buku dilaporkan hilang';
                pinjaman.tarikhSebenarPulang = new Date().toISOString().split('T')[0];
                
                try {
                    const response = await fetch("https://script.google.com/macros/s/AKfycbz1QLVnMzAs9jwMkaZMWHaiLfUFkrb1P5sKeeXZ-3Vs6xoVWvOZOU97OIZotLyLOPJm/exec", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...pinjaman,
                            action: 'update'
                        })
                    });
                    
                    if (response.ok) {
                        localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                        muatJadualPinjaman();
                        updateDashboard();
                        hideModal();
                        alert('Buku telah ditandakan sebagai hilang!');
                    } else {
                        throw new Error('Gagal mengemas kini data');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                    muatJadualPinjaman();
                    updateDashboard();
                    hideModal();
                    alert('Buku ditandakan hilang (disimpan secara tempatan)');
                }
            });
        }

        function padamPinjaman(index) {
            const pinjaman = pinjamanList[index];
            showModal(`Adakah anda pasti ingin memadam rekod pinjaman ini?\n\nMurid: ${pinjaman.nama}\nBuku: ${pinjaman.tajukBuku}\nStatus: ${pinjaman.status}`, function() {
                pinjamanList.splice(index, 1);
                localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));
                muatJadualPinjaman();
                updateDashboard();
                muatSenaraiMurid(); // Update student list
                hideModal();
                alert('‚úÖ Rekod pinjaman telah dipadam.');
            });
        }

        // Dashboard functions
        function updateDashboard() {
            const totalMurid = muridList.length;
            const totalPinjaman = pinjamanList.length;
            const sedangDipinjam = pinjamanList.filter(p => p.status === 'Dipinjam').length;
            const telahDikembalikan = pinjamanList.filter(p => p.status === 'Dikembalikan').length;
            const lewatPulang = pinjamanList.filter(p => p.status === 'Lewat').length;
            const bukuHilang = pinjamanList.filter(p => p.status === 'Hilang').length;
            
            document.getElementById('totalMurid').textContent = totalMurid;
            document.getElementById('totalPinjaman').textContent = totalPinjaman;
            document.getElementById('sedangDipinjam').textContent = sedangDipinjam;
            document.getElementById('telahDikembalikan').textContent = telahDikembalikan;
            document.getElementById('lewatPulang').textContent = lewatPulang;
            document.getElementById('bukuHilang').textContent = bukuHilang;
            
            // Update top borrower for current month
            updateTopBorrowerCard();
            updateCharts();
            updateTopBorrowers();
        }

        function updateTopBorrowerCard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // Filter loans for current month
            const currentMonthLoans = pinjamanList.filter(loan => {
                const loanDate = new Date(loan.tarikhPinjaman);
                return loanDate.getMonth() === currentMonth && loanDate.getFullYear() === currentYear;
            });
            
            // Count loans per student
            const borrowerCounts = {};
            currentMonthLoans.forEach(loan => {
                const key = `${loan.nama}|${loan.kelas}`;
                borrowerCounts[key] = (borrowerCounts[key] || 0) + 1;
            });
            
            // Find top borrower
            let topBorrower = null;
            let maxLoans = 0;
            
            Object.entries(borrowerCounts).forEach(([key, count]) => {
                if (count > maxLoans) {
                    maxLoans = count;
                    const [nama, kelas] = key.split('|');
                    topBorrower = { nama, kelas, count };
                }
            });
            
            if (topBorrower) {
                document.getElementById('peminjamTerbanyak').textContent = topBorrower.nama;
                document.getElementById('jumlahPinjaman').textContent = `${topBorrower.count} pinjaman`;
            } else {
                document.getElementById('peminjamTerbanyak').textContent = '-';
                document.getElementById('jumlahPinjaman').textContent = '0 pinjaman';
            }
        }

        function updateTopBorrowers() {
            const selectedMonth = document.getElementById('pilihBulan').value;
            const currentDate = new Date();
            const targetMonth = selectedMonth === '' ? currentDate.getMonth() : parseInt(selectedMonth);
            const targetYear = currentDate.getFullYear();
            
            // Filter loans for selected month
            const monthLoans = pinjamanList.filter(loan => {
                const loanDate = new Date(loan.tarikhPinjaman);
                return loanDate.getMonth() === targetMonth && loanDate.getFullYear() === targetYear;
            });
            
            // Count loans per student
            const borrowerCounts = {};
            monthLoans.forEach(loan => {
                const key = `${loan.nama}|${loan.kelas}`;
                if (!borrowerCounts[key]) {
                    borrowerCounts[key] = {
                        nama: loan.nama,
                        kelas: loan.kelas,
                        count: 0,
                        latestStatus: loan.status
                    };
                }
                borrowerCounts[key].count++;
                // Update with latest loan status
                if (new Date(loan.tarikhPinjaman) > new Date(borrowerCounts[key].latestDate || '1900-01-01')) {
                    borrowerCounts[key].latestStatus = loan.status;
                    borrowerCounts[key].latestDate = loan.tarikhPinjaman;
                }
            });
            
            // Sort by loan count (descending)
            const sortedBorrowers = Object.values(borrowerCounts)
                .sort((a, b) => b.count - a.count)
                .slice(0, 10); // Top 10
            
            // Update table
            const tbody = document.getElementById('senaraiPeminjamTerbanyak');
            tbody.innerHTML = '';
            
            if (sortedBorrowers.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="5" class="border border-gray-300 px-4 py-2 text-center text-gray-500">
                        Tiada data pinjaman untuk bulan yang dipilih
                    </td>
                `;
                return;
            }
            
            sortedBorrowers.forEach((borrower, index) => {
                const row = tbody.insertRow();
                const position = index + 1;
                let positionIcon = '';
                let positionClass = '';
                
                if (position === 1) {
                    positionIcon = 'ü•á';
                    positionClass = 'text-yellow-600 font-bold';
                } else if (position === 2) {
                    positionIcon = 'ü•à';
                    positionClass = 'text-gray-500 font-bold';
                } else if (position === 3) {
                    positionIcon = 'ü•â';
                    positionClass = 'text-orange-600 font-bold';
                } else {
                    positionIcon = position;
                    positionClass = 'text-gray-700';
                }
                
                const statusClass = borrower.latestStatus === 'Lewat' ? 'text-red-600 font-bold' : 
                                  borrower.latestStatus === 'Dikembalikan' ? 'text-green-600' : 
                                  borrower.latestStatus === 'Hilang' ? 'text-red-800 font-bold' : 'text-blue-600';
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2 ${positionClass}">${positionIcon}</td>
                    <td class="border border-gray-300 px-4 py-2 font-medium">${borrower.nama}</td>
                    <td class="border border-gray-300 px-4 py-2">${borrower.kelas}</td>
                    <td class="border border-gray-300 px-4 py-2 text-center font-bold text-blue-600">${borrower.count}</td>
                    <td class="border border-gray-300 px-4 py-2 ${statusClass}">${borrower.latestStatus}</td>
                `;
            });
        }

        function initCharts() {
            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Dipinjam', 'Dikembalikan', 'Lewat', 'Hilang'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Kelas Chart
            const kelasCtx = document.getElementById('kelasChart').getContext('2d');
            kelasChart = new Chart(kelasCtx, {
                type: 'bar',
                data: {
                    labels: ['3 BERLIAN', '3 DELIMA', '3 INTAN', '3 MUTIARA', '3 ZAMRUD', '4 BERLIAN', '4 DELIMA', '4 INTAN', '4 MUTIARA', '4 ZAMRUD', '5 BERLIAN', '5 DELIMA', '5 INTAN', '5 MUTIARA', '5 ZAMRUD', '6 BERLIAN', '6 DELIMA', '6 INTAN', '6 MUTIARA', '6 ZAMRUD'],
                    datasets: [{
                        label: 'Jumlah Pinjaman',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (!statusChart || !kelasChart) return;
            
            // Update status chart
            const sedangDipinjam = pinjamanList.filter(p => p.status === 'Dipinjam').length;
            const telahDikembalikan = pinjamanList.filter(p => p.status === 'Dikembalikan').length;
            const lewatPulang = pinjamanList.filter(p => p.status === 'Lewat').length;
            const bukuHilang = pinjamanList.filter(p => p.status === 'Hilang').length;
            
            statusChart.data.datasets[0].data = [sedangDipinjam, telahDikembalikan, lewatPulang, bukuHilang];
            statusChart.update();
            
            // Update kelas chart
            const kelasList = ['3 BERLIAN', '3 DELIMA', '3 INTAN', '3 MUTIARA', '3 ZAMRUD', '4 BERLIAN', '4 DELIMA', '4 INTAN', '4 MUTIARA', '4 ZAMRUD', '5 BERLIAN', '5 DELIMA', '5 INTAN', '5 MUTIARA', '5 ZAMRUD', '6 BERLIAN', '6 DELIMA', '6 INTAN', '6 MUTIARA', '6 ZAMRUD'];
            const kelasData = kelasList.map(kelas => 
                pinjamanList.filter(p => p.kelas === kelas).length
            );
            
            kelasChart.data.datasets[0].data = kelasData;
            kelasChart.update();
        }

        // Modal functions
        function showModal(message, onConfirm) {
            document.getElementById('pesanKonfirmasi').textContent = message;
            document.getElementById('modalKonfirmasi').classList.remove('hidden');
            document.getElementById('modalKonfirmasi').classList.add('flex');
            
            document.getElementById('btnYa').onclick = onConfirm;
            document.getElementById('btnTidak').onclick = hideModal;
        }

        function hideModal() {
            document.getElementById('modalKonfirmasi').classList.add('hidden');
            document.getElementById('modalKonfirmasi').classList.remove('flex');
        }

        // Print function
        function cetakLaporan() {
            document.getElementById('tarikhCetak').textContent = new Date().toLocaleDateString('ms-MY');
            setTimeout(() => {
                window.print();
            }, 100);
        }
    
async function loadDataFromSheet() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getData');
        const data = await response.json();

        if (data.muridList) muridList = data.muridList;
        if (data.pinjamanList) pinjamanList = data.pinjamanList;

        // Cache locally for faster reloads
        localStorage.setItem('muridList', JSON.stringify(muridList));
        localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));

        // Refresh UI
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();

    } catch (error) {
        console.error('Error loading from Google Sheets:', error);
        // Fallback to local cache if offline
        muridList = JSON.parse(localStorage.getItem('muridList')) || [];
        pinjamanList = JSON.parse(localStorage.getItem('pinjamanList')) || [];
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();
    }
}

</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96b33f5931280c6d',t:'MTc1NDUzMjczMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
async function loadDataFromSheet() {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getData');
        const data = await response.json();

        if (data.muridList) muridList = data.muridList;
        if (data.pinjamanList) pinjamanList = data.pinjamanList;

        // Cache locally for faster reloads
        localStorage.setItem('muridList', JSON.stringify(muridList));
        localStorage.setItem('pinjamanList', JSON.stringify(pinjamanList));

        // Refresh UI
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();

    } catch (error) {
        console.error('Error loading from Google Sheets:', error);
        // Fallback to local cache if offline
        muridList = JSON.parse(localStorage.getItem('muridList')) || [];
        pinjamanList = JSON.parse(localStorage.getItem('pinjamanList')) || [];
        muatSenaraiMurid();
        muatJadualPinjaman();
        updateDashboard();
    }
}

</script></body>
</html>

